# 要件定義書：三日坊主バスター

## 1. サービス概要

| 項目 | 内容 |
|------|------|
| サービス名 | 三日坊主バスター |
| 種別 | Webアプリ（小規模・1〜3ページ） |
| ターゲット | 個人（一般消費者） |
| コンセプト | 習慣を登録し、毎日チェックイン。「続けたくなる育成要素」と「サボると拡散される恥の力」で三日坊主を防止する |
| 競合優位性 | ① 育成キャラの成長/衰退でやめられなくなる ② X自動投稿で社会的プレッシャーと自然拡散を両立 |

## 2. 解決する課題

- 習慣を始めても続かない（三日坊主問題）
- モチベーション維持の仕組みがない
- 既存アプリは「宣言するだけ」で強制力がない
- 既存アプリはバイラル（自然拡散）の仕組みがない

## 3. コア戦略：2本柱

### 柱A：続けたくなる要素（育成ポイントシステム）
- 習慣達成 → **+1ポイント**（コツコツ積み上げる喜び）
- 1日でも未達成 → **−5ポイント**（損失回避バイアスで離脱を防ぐ）
- ポイントに応じてキャラクターが進化／退化する
- 「せっかく育てたキャラを失いたくない」心理が継続の原動力

### 柱B：拡散されやすくなる要素（X自動投稿）
- 週間クリア状況をXに自動投稿
- ツイート内にサイトURLを必ず含める → 閲覧者がアプリへ流入
- 達成報告 = ポジティブ拡散、未達成報告 = 恥の力で抑止
- **ユーザーが増える → 投稿が増える → さらにユーザーが増える** の好循環

### 強制力の手段（優先順位順）
1. **X自動投稿**（最優先）— 週間レポート + サイトURL で拡散と集客を兼ねる
2. **育成ポイント＋キャラクター** — サボると−5ptでキャラが弱体化（損失回避）
3. **グループチャレンジ** — 仲間に迷惑をかける連帯責任制（将来）

## 4. 機能要件

### 4.1 習慣の登録・管理（実装済み）
- 習慣名を入力して登録（例：「走る」「料理を作る」「英会話1時間」）
- 習慣の編集・削除
- チャレンジ期間の設定（7日 / 14日 / 30日 / カスタム）

### 4.2 毎日のチェックイン（実装済み）
- 今日の習慣一覧を表示
- 各習慣に「達成!」ボタンを配置
- 達成時：褒めメッセージをランダム表示
- 午前0時で日付リセット（自動判定）

### 4.3 連続達成・ストリーク表示（実装済み）
- 連続達成日数をカウント・表示
- マイルストーン表示（3日・7日・14日・30日）

### 4.4 育成ポイント＋キャラクターシステム（★ 未実装・Next Action）

#### ポイントルール
| イベント | ポイント | 備考 |
|----------|----------|------|
| 習慣を1つ達成 | **+1** | 1日に複数習慣があれば習慣ごとに+1 |
| 1日でも未チェックイン | **−5** | 未達成の習慣1つにつき−5 |
| ポイント下限 | **0** | マイナスにはならない |

#### キャラクター進化テーブル
| ポイント範囲 | キャラクター | 状態名 |
|-------------|-------------|--------|
| 0 pt | 💀 ガイコツ | 死亡 |
| 1 〜 4 pt | 🥚 タマゴ | 誕生 |
| 5 〜 14 pt | 🐣 ヒヨコ | 成長中 |
| 15 〜 29 pt | 🐥 小鳥 | 元気 |
| 30 〜 59 pt | 🦅 ワシ | 飛翔 |
| 60 pt 〜 | 🐉 ドラゴン | 最強 |

#### 表示仕様
- ダッシュボードにキャラクター＋現在ポイントを常時表示
- ポイント増減時にアニメーション演出（+1 は緑フェード、−5 は赤シェイク）
- キャラクター変化時に進化／退化エフェクト
- 「あと○ptで次の進化!」の表示でモチベーション維持

#### データ設計
- `user_points` テーブル（Supabase）
  - `user_id` (UUID, FK → auth.users)
  - `total_points` (INTEGER, DEFAULT 0)
  - `current_character` (TEXT)
  - `updated_at` (TIMESTAMPTZ)
- ポイント変動ログ: `point_history` テーブル
  - `id`, `user_id`, `habit_id`, `delta` (+1 or -5), `reason`, `created_at`

### 4.5 X（Twitter）自動投稿機能（★ 未実装・Next Action）

#### 認証フロー
- X OAuth 2.0 (PKCE) でアカウント連携
- 初回のみ30秒の認証操作、以降は自動
- いつでもON/OFF切替・連携解除可能

#### 投稿タイプ

**① 週間レポート（メイン）**
- 毎週日曜 21:00 に自動投稿（Supabase Edge Function + cron）
- テンプレート例：
  ```
  📊 今週の三日坊主バスター
  ✅ 達成: 5/7日
  🔥 ストリーク: 12日連続
  🐥 キャラ: 小鳥 (23pt)

  今週もがんばった！
  #三日坊主バスター
  https://mikka-bouzu-buster.com
  ```

**② 達成マイルストーン投稿**
- 7日・14日・30日連続達成時に自動投稿
- テンプレート例：
  ```
  🎉 30日連続達成！ドラゴンに進化！🐉
  「毎日走る」を1ヶ月続けました！
  #三日坊主バスター
  https://mikka-bouzu-buster.com
  ```

**③ キャラクター進化投稿（オプション）**
- キャラが進化した瞬間に投稿
- テンプレート例：
  ```
  🐣→🐥 キャラが小鳥に進化！(15pt到達)
  #三日坊主バスター
  https://mikka-bouzu-buster.com
  ```

**④ 未達成レポート（恥の力）**
- ユーザーがONにした場合のみ
- テンプレート例：
  ```
  😱 今日は「毎日走る」をサボりました... -5pt
  キャラがヒヨコに退化...🐣
  #三日坊主バスター
  https://mikka-bouzu-buster.com
  ```

#### 共通ルール
- **全ツイートにサイトURL `https://mikka-bouzu-buster.com` を必ず含める**
- 投稿内容の事前プレビュー表示
- ユーザーがテンプレートをカスタム可能
- X API Free プラン（月1,500投稿 / アプリ単位）で運用

#### 技術要件
| 項目 | 仕様 |
|------|------|
| API | X API v2 (OAuth 2.0 PKCE) |
| トークン管理 | Supabase にアクセストークン＋リフレッシュトークンを暗号化保存 |
| 定期実行 | Supabase Edge Function + pg_cron（週次レポート） |
| コールバックURL | `https://mikka-bouzu-buster.com/callback` |

### 4.6 デポジット表示（実装済み・モックのみ）
- 擬似デポジット金額の設定（表示のみ）
- チャレンジ結果画面での達成率表示
- ※実際の決済機能は実装しない

## 5. 非機能要件

| 項目 | 内容 |
|------|------|
| デザイン | ミニマル・モダン |
| レスポンシブ | スマホ・PC両対応 |
| データ保存 | Supabase（PostgreSQL）+ localStorage（オフラインフォールバック） |
| 認証 | Supabase 匿名認証（実装済み）→ X OAuth 2.0（次期） |
| ホスティング | Cloudflare Pages |
| ドメイン | mikka-bouzu-buster.com |
| SEO/OGP | 実装済み |
| PWA | 実装済み（ホーム画面追加対応） |

## 6. 技術スタック

| レイヤー | 技術 |
|----------|------|
| 構造 | HTML5 |
| スタイル | CSS3（カスタムプロパティ活用） |
| ロジック | Vanilla JavaScript（ES6+） |
| バックエンド | Supabase（PostgreSQL + Auth + Edge Functions） |
| 定期実行 | Supabase Edge Function + pg_cron |
| ホスティング | Cloudflare Pages |
| バージョン管理 | Git / GitHub |
| SNS連携 | X API v2（OAuth 2.0 PKCE） |

## 7. 画面構成

### P1: ダッシュボード（メイン画面）— 実装済み → 改修予定
- 今日の日付
- **育成キャラクター表示（大きく中央に配置）**
- **現在ポイント + 次の進化までの表示**
- 登録済み習慣の一覧（チェックイン状態付き）
- 各習慣の連続達成日数
- 「+習慣を追加」ボタン

### P2: 習慣登録・編集モーダル — 実装済み
- 習慣名の入力
- チャレンジ期間の選択
- デポジット金額の設定（モック）
- X自動投稿の設定（ON/OFF・テンプレート選択）
- 保存 / キャンセルボタン

### P3: チャレンジ結果画面 — 実装済み
- 期間終了時の達成率表示
- デポジット結果表示（モック）
- 次のチャレンジへの導線

### P4: 設定画面（未実装）
- X アカウント連携・解除
- X投稿タイプの選択（週間レポート / マイルストーン / 進化通知 / 未達成）
- 投稿テンプレートのカスタマイズ
- 言語切替（日英）
- データエクスポート

## 8. 開発ロードマップ

| Sprint | 内容 | 状態 |
|--------|------|------|
| 0 | 要件定義 + フロントエンドMVP | ✅ 完了 |
| 1 | 独自ドメイン + Cloudflare Pages + SEO/PWA | ✅ 完了 |
| 2-3 | Supabase DB + 匿名認証 | ✅ 完了 |
| **4a** | **育成ポイント + キャラクターシステム（フロント + DB）** | **★ Next Action** |
| **4b** | **X OAuth 2.0 連携 + 自動投稿機能** | **★ Next Action** |
| 5 | 週間レポート定期実行（Edge Function + cron） | 未着手 |
| 6 | Googleログイン + プッシュ通知 | 未着手 |
| 7 | グループチャレンジ | 未着手 |
| 8 | 運用体制（Sentry, CI/CD） | 未着手 |

## 9. Next Action 詳細

### Step 1: 育成ポイント + キャラクター（Sprint 4a）
1. Supabase に `user_points` + `point_history` テーブル作成
2. チェックイン時に +1pt のロジック追加（app.js）
3. 日付変更時に未達成習慣を検出し −5pt のロジック追加
4. ダッシュボードにキャラクター表示エリアを追加（HTML/CSS）
5. ポイント増減アニメーション実装
6. キャラクター進化/退化エフェクト実装

### Step 2: X API 連携（Sprint 4b）
1. X Developer Portal でアプリ登録（OAuth 2.0 PKCE）
2. Supabase に `x_tokens` テーブル作成（暗号化トークン保存）
3. OAuth認証フロー実装（ログイン → コールバック → トークン保存）
4. 投稿API呼び出し関数の実装
5. 設定画面でX連携ON/OFF + 投稿タイプ選択UI

### Step 3: 週間レポート自動投稿（Sprint 5）
1. Supabase Edge Function で週間集計ロジック作成
2. pg_cron で毎週日曜 21:00 にトリガー設定
3. 投稿テンプレートにURL・キャラ・ポイント情報を動的埋め込み
4. 投稿履歴の記録と確認画面

## 10. 将来拡張（対象外）

- グループチャレンジ（連帯責任制）
- 人質コンテンツ機能
- バッジ・称号システム
- カレンダーヒートマップ
- SNSシェアカード画像生成（OGP動的生成）
- ダークモード
- キャラクターのカスタマイズ（着せ替え等）

## 11. ビジネスモデル

| 収益源 | 詳細 |
|--------|------|
| フリーミアム | 基本無料。習慣3つまで無料 / 無制限は月額¥300 |
| 法人プラン | 企業の健康経営・研修用に月額課金 |
| ※金銭デポジット | 法的リスク（資金移動業等）のため実装しない |
