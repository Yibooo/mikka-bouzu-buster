<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Xé€£æºä¸­... - ä¸‰æ—¥åŠä¸»ãƒã‚¹ã‚¿ãƒ¼</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100dvh;
    margin: 0;
    background: #f7f7f8;
    color: #1a1a1a;
  }
  .container {
    text-align: center;
    padding: 40px 20px;
    max-width: 400px;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e5e7eb;
    border-top-color: #2563eb;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 20px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  h2 { font-size: 1.2rem; margin-bottom: 8px; }
  p { color: #6b7280; font-size: 0.9rem; }
  .success { color: #16a34a; }
  .error { color: #dc2626; }
</style>
</head>
<body>
<div class="container">
  <div class="spinner" id="spinner"></div>
  <h2 id="title">Xé€£æºå‡¦ç†ä¸­...</h2>
  <p id="message">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
</div>

<script>
(async () => {
  const title = document.getElementById("title");
  const message = document.getElementById("message");
  const spinner = document.getElementById("spinner");

  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const state = params.get("state");
  const error = params.get("error");

  if (error) {
    spinner.style.display = "none";
    title.textContent = "é€£æºãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ";
    title.className = "error";
    message.textContent = "3ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™...";
    setTimeout(() => { window.location.href = "/"; }, 3000);
    return;
  }

  // Verify state
  const savedState = sessionStorage.getItem("x_oauth_state");
  if (!code || !state || state !== savedState) {
    spinner.style.display = "none";
    title.textContent = "ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ";
    title.className = "error";
    message.textContent = "state ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    setTimeout(() => { window.location.href = "/"; }, 3000);
    return;
  }

  const codeVerifier = sessionStorage.getItem("x_code_verifier");
  const redirectUri = `${window.location.origin}/callback.html`;

  // Get device ID (same as main app)
  let userId = localStorage.getItem("hb_device_id");
  if (!userId) {
    userId = crypto.randomUUID();
    localStorage.setItem("hb_device_id", userId);
  }

  try {
    const res = await fetch("/api/x/token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        code,
        code_verifier: codeVerifier,
        redirect_uri: redirectUri,
        user_id: userId,
      }),
    });

    const data = await res.json();

    if (data.success) {
      // åˆå›ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è‡ªå‹•æŠ•ç¨¿
      const username = data.x_username ? `@${data.x_username}` : "";
      const tweetText = `ğŸ£ ä¸‰æ—¥åŠä¸»ãƒã‚¹ã‚¿ãƒ¼ã‚’å§‹ã‚ã¾ã—ãŸï¼\n\nãƒ’ãƒ¨ã‚³ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆğŸ¥šâ†’ğŸ£â†’ğŸ¥â†’ğŸ¦…â†’ğŸ‰\nç¿’æ…£ã‚’ç¶šã‘ã¦ã‚­ãƒ£ãƒ©ã‚’è‚²ã¦ã¾ã™ï¼\n\n#ä¸‰æ—¥åŠä¸»ãƒã‚¹ã‚¿ãƒ¼\nhttps://mikka-bouzu-buster.com`;

      try {
        const tweetRes = await fetch("/api/x/tweet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userId, text: tweetText }),
        });
        const tweetData = await tweetRes.json();

        spinner.style.display = "none";
        title.textContent = "Xé€£æºå®Œäº†!";
        title.className = "success";
        if (tweetData.success) {
          message.textContent = username
            ? `${username} ã¨ã—ã¦é€£æºã—ã€åˆå›ãƒ„ã‚¤ãƒ¼ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸğŸ‰\n5ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™...`
            : "é€£æºå®Œäº†ï¼†åˆå›ãƒ„ã‚¤ãƒ¼ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸğŸ‰\n5ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™...";
        } else {
          message.textContent = username
            ? `${username} ã¨ã—ã¦é€£æºã—ã¾ã—ãŸï¼ˆãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿ã¯å¤±æ•—: ${tweetData.error || "ä¸æ˜"}ï¼‰\n5ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™...`
            : "é€£æºå®Œäº†ï¼ˆãƒ„ã‚¤ãƒ¼ãƒˆæŠ•ç¨¿ã¯å¤±æ•—ï¼‰\n5ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™...";
        }
      } catch (tweetErr) {
        spinner.style.display = "none";
        title.textContent = "Xé€£æºå®Œäº†!";
        title.className = "success";
        message.textContent = username
          ? `${username} ã¨ã—ã¦é€£æºã—ã¾ã—ãŸï¼ˆåˆå›ãƒ„ã‚¤ãƒ¼ãƒˆã¯é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰\n5ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™...`
          : "é€£æºå®Œäº†ï¼ˆåˆå›ãƒ„ã‚¤ãƒ¼ãƒˆã¯é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰\n5ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™...";
      }
    } else {
      spinner.style.display = "none";
      title.textContent = "é€£æºã«å¤±æ•—ã—ã¾ã—ãŸ";
      title.className = "error";
      message.textContent = (data.error || "ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„") + (data.detail ? `\n[è©³ç´°] ${data.detail}` : "");
    }
  } catch (e) {
    spinner.style.display = "none";
    title.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
    title.className = "error";
    message.textContent = e.message;
  }

  // Cleanup
  sessionStorage.removeItem("x_oauth_state");
  sessionStorage.removeItem("x_code_verifier");

  setTimeout(() => { window.location.href = "/"; }, 5000);
})();
</script>
</body>
</html>
